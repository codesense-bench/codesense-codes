# OSS-Fuzz dataset for trace modeling

This repository holds utilities to download, build, fuzz, and trace projects curated in the [OSS-Fuzz project](https://github.com/google/oss-fuzz).
The intended purpose is to generate a dataset for trace modeling as a follow-up to [TRACED](https://arxiv.org/abs/2306.07487).

# Data model

Here are how the data are organized.

- Project, e.g. `apache-httpd`
  - Fuzzer/Fuzzing harness, e.g. `fuzz_addr_parse`
    - Fuzzing run, including the fuzzer, seed, and other parameters, e.g. (`libfuzzer`, `seed 0`, `parameters ...`)
      - Input/Execution in the corpus generated in a fuzzing run, e.g. ID `12345678`. Generally, one trace is generated per input.
        - Function in an execution, e.g. `parse_abc()`.
          - Execution of a function, i.e. the function's unique ID and a set of assignments to the input variables.

# Usage

The main entry point for all actions is `infra/helper.py`.
Helper scripts are organized under subdirectories in `scripts/`.

Here is the pipeline in pseudocode:

```python
PROJECTS = select_projects() # e.g. all C projects
FUZZER = select_fuzzer()     # e.g. AFL++

dataset = []
for project in PROJECTS: # e.g. apache-httpd
    # Get the source code to use for carving.
    source_code = get_source_code(project)
    # Build the harnesses for a project.
    # This is done in the container via `compile` which runs `projects/{project}/build.sh`.
    harnesses = build_harnesses(project)
    for harness in harnesses: # e.g. fuzz_addr_parse
        # Generate a corpus for each harness.
        corpus = run_fuzzer(harness, FUZZER)
        # Filter inputs, e.g. to remove low-coverage executions.
        corpus = filter_inputs(corpus)
        # Run the inputs in the corpus and log a dataset of traces.
        program_traces = run_tracer(harness, corpus)
        # "Carve" each program-level trace into many scoped traces of each function.
        function_traces = carve_traces(program_traces, source_code)
        # Collect traces from multiple projects/fuzzers for the training dataset.
        dataset.append(function_traces)

dataset = filter_traces(dataset)    # Filter data, e.g. to remove duplicate function executions.
train_model(dataset)                # Train the trace model.
```

See `scripts/test_end_to_end.sh` for an example.

## First-time setup

Run this script to set up the project:
- Build the custom Docker containers
- Generate the list of projects
- Create a virtual environment and install Python dependencies
- Clone tracer tool
- Run a basic end-to-end test

```bash
bash scripts/setup.sh
bash scripts/test_end_to_end.sh
```

## Setup environment

To set up the output/working directory for testing the infra scripts:

```bash
export TRACED_ROOT="trace_test"
mkdir -p $TRACED_ROOT
```

## Build fuzzers

To build all fuzzers for a specific project:

```bash
bash scripts/build_fuzzers/build_project_fuzzers.sh apache-httpd
```

## Run fuzzers to generate corpora

To run a specific fuzzer for a specific project/fuzzer:

```bash
bash scripts/run_fuzzer2/fuzz_one.sh apache-httpd fuzz_addr_parse
```

## Trace executions in a corpus

To trace the generated corpus for a specific project/fuzzer:

```bash
bash scripts/run_tracer2/wrap_one.sh apache-httpd fuzz_addr_parse
bash scripts/run_tracer2/trace_one.sh apache-httpd fuzz_addr_parse $TRACED_ROOT/corpus $TRACED_ROOT/traces
```

## (OPTIONAL) To build all projects and fuzz all harnesses:

```bash
bash scripts/build_fuzzers/build_all_fuzzers.sh
bash scripts/run_fuzzer2/fuzz_all.sh
```

# Generated data

The generated data has the following structure:

```
trace_test
├── build
│   ├── out
│   │   └── apache-httpd
│   │       ├── fuzz_addr_parse
│   │       ├── more fuzzers and build outputs...
│   │       └── fuzz_utils
│   └── work
│       └── apache-httpd
│           └── c_code_export
├── corpus
│   └── apache-httpd
│       └── fuzz_addr_parse
│           ├── 00afd5c0631de5ca19efaddbebf08b5815011694
│           ├── mode corpus files...
│           └── ff6b50dc94f76aeda88631ded549533aa62e93ca
└── traces
    └── log.xml
```

- `build/` holds the build outputs.
  - `out/<project>/` holds the fuzzer harness binaries.
  - `work/<project>/c_code_export` holds the archive of the project's source code.
- `corpus/` holds the input data corpus generated by the fuzzer.
- `traces/` holds the XML files output by the tracer, containing trees of function calls and variable values.
